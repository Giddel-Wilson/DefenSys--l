import mongoose from 'mongoose';
const { Schema, model, models } = mongoose;

export interface IVulnerability {
	_id?: string;
	scanId: string;
	type: string;
	severity: 'critical' | 'high' | 'medium' | 'low' | 'info';
	title: string;
	description: string;
	affectedUrl?: string;
	affectedParameter?: string;
	evidence?: string;
	recommendation: string;
	cveId?: string;
	cvssScore?: number;
	status: 'open' | 'fixed' | 'accepted' | 'false_positive';
	createdAt: Date;
	updatedAt: Date;
}

const vulnerabilitySchema = new Schema<IVulnerability>(
	{
		scanId: {
			type: String,
			required: true,
			index: true
		},
		type: {
			type: String,
			required: true,
			enum: [
				'SQL Injection',
				'XSS',
				'CSRF',
				'Broken Auth',
				'Weak Passwords',
				'Insecure Config',
				'Sensitive Data',
				'Missing Encryption',
				'Security Headers',
				'SSL/TLS',
				'Open Ports',
				'Cookie Security',
				'CORS Policy',
				'Server Configuration',
				'Information Disclosure',
				'Other'
			]
		},
		severity: {
			type: String,
			required: true,
			enum: ['critical', 'high', 'medium', 'low', 'info']
		},
		title: {
			type: String,
			required: true
		},
		description: {
			type: String,
			required: true
		},
		affectedUrl: {
			type: String
		},
		affectedParameter: {
			type: String
		},
		evidence: {
			type: String
		},
		recommendation: {
			type: String,
			required: true
		},
		cveId: {
			type: String
		},
		cvssScore: {
			type: Number,
			min: 0,
			max: 10
		},
		status: {
			type: String,
			enum: ['open', 'fixed', 'accepted', 'false_positive'],
			default: 'open'
		}
	},
	{
		timestamps: true
	}
);

// Indexes
vulnerabilitySchema.index({ scanId: 1, severity: 1 });
vulnerabilitySchema.index({ type: 1 });
vulnerabilitySchema.index({ status: 1 });

// Delete the model if it exists (to ensure schema updates are applied)
if (models.Vulnerability) {
	delete models.Vulnerability;
}

// Export the model
export const Vulnerability = model<IVulnerability>('Vulnerability', vulnerabilitySchema);
